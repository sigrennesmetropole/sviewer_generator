var geojsonLayerMap,fond_plan_defaut_selectionne,nom_commune_selectionne,theme_site_orgs_selectionnes,equipements_techniques_selectionnes,layer_pvci=L.tileLayer("https://public.sig.rennesmetropole.fr/geowebcache/service/tms/1.0.0/ref_fonds%3Apvci_fondplan@EPSG%3A3857@png/{z}/{x}/{y}.png",{attribution:"Plan de ville communal et intercommunal, Référentiel voies et adresses : Rennes Métropole",id:1,center:[48.1,-1.67],minZoom:0,maxZoom:20,tms:!0}),map=L.map("carte_emprise",{center:[48.1,-1.67],zoom:10,layers:[layer_pvci]}),configueration_sviewer_selectionne=$("input[name=configuration_sviewer]:checked").val(),titre_carte=$("#titre_sviewer").val(),largeur_iframe=$("#largeur_iframe").val(),hauteur_iframe=$("#hauteur_iframe").val(),map_centre_lat=map.getCenter().lat,map_centre_lng=map.getCenter().lng,map_zoom=map.getZoom();function generer_url_sviewer(){var e=base_url_sviewer+"?x="+map_centre_lng+"&y="+map_centre_lat+"&z="+map_zoom+"&lb="+fond_plan_defaut_selectionne;""!=titre_carte&&(e+="&title="+encodeURIComponent(titre_carte));var r=theme_site_orgs_selectionnes.length,t=equipements_techniques_selectionnes.length,n="";if(r>0){e+="&layers=",n=theme_site_orgs_selectionnes[0];for(var a=1;a<r-1;a++)n+=","+theme_site_orgs_selectionnes[a];if(t>0)for(var i=0;i<t-1;i++)n+=","+equipements_techniques_selectionnes[i];e+=encodeURIComponent(n)}else if(t>0){e+="&layers=",n=equipements_techniques_selectionnes[0];for(var s=1;s<t-1;s++)n+=","+equipements_techniques_selectionnes[s];e+=encodeURIComponent(n)}return"allegee"==configueration_sviewer_selectionne&&(e+="&c=light"),e}function afficher_coordonnees_carte(e,r){var t={color:r,weight:3,opacity:1};null!=geojsonLayerMap&&map.removeLayer(geojsonLayerMap),""!=e&&(geojsonLayerMap=L.geoJSON(e,{style:t}).addTo(map),map.fitBounds(geojsonLayerMap.getBounds()))}$.getJSON(base_url_cadastre+"communes",function(e){var r=$.map(e,function(e){return{text:e.name,id:e.idComm}});afficher_select2("liste_communes",r,"choix de la commune",!0,!1),$("#liste_communes").val("350001").trigger("change"),nom_commune_selectionne=$("#liste_communes").val()}),$.getJSON("assets/json/donnees_sites_orgs.json",function(e){var r=$.map(e.sites_organismes,function(e){return{text:e.text,id:e.couche}});afficher_select2("liste_site_org",r,"ajouter un theme base sites & organismes",!1,!0),theme_site_orgs_selectionnes=$("#liste_site_org").val()}),$.getJSON("assets/json/fonds_plans.json",function(e){var r=$.map(e.fonds_plans,function(e){return{text:e.text,id:e.id}});afficher_select2("liste_fonds_plans",r,"choix du fond de plan par defaut",!0,!1),$("#liste_fonds_plans").val("0").trigger("change"),fond_plan_defaut_selectionne=$("#liste_fonds_plans").val()}),$.getJSON("assets/json/donnees_metiers.json",function(e){var r=$.map(e.donnees_metiers,function(e){return{text:e.nom,id:e.couche}});afficher_select2("liste_equipements_techniques",r,"ajouter donnees metiers",!1,!0),equipements_techniques_selectionnes=$("#liste_equipements_techniques").val()}),$("#liste_communes").on("select2:select",function(e){var r=e.params.data;""!=r.id&&1!=r.id&&$.get(base_url_cadastre+"epsg:4326/commune/"+r.id,function(e){afficher_coordonnees_carte(e.coordonnees,"#6a00ff")}),nom_commune_selectionne=$("#liste_communes").val();var t=generer_url_sviewer();afficher_resultat(t,largeur_iframe,hauteur_iframe)}),$("#liste_fonds_plans").on("select2:select",function(e){fond_plan_defaut_selectionne=$("#liste_fonds_plans").val();var r=generer_url_sviewer();afficher_resultat(r,largeur_iframe,hauteur_iframe)}),$("#liste_site_org").on("select2:select",function(e){theme_site_orgs_selectionnes=$("#liste_site_org").val();var r=generer_url_sviewer();afficher_resultat(r,largeur_iframe,hauteur_iframe)}),$("#liste_site_org").on("select2:unselecting",function(e){var r=e.params.args.data.id,t=theme_site_orgs_selectionnes.indexOf(r),n=(theme_site_orgs_selectionnes.splice(t,1),generer_url_sviewer());afficher_resultat(n,largeur_iframe,hauteur_iframe)}),$("#liste_equipements_techniques").on("select2:select",function(e){equipements_techniques_selectionnes=$("#liste_equipements_techniques").val();var r=generer_url_sviewer();afficher_resultat(r,largeur_iframe,hauteur_iframe)}),$("#liste_equipements_techniques").on("select2:unselecting",function(e){var r=e.params.args.data.id,t=equipements_techniques_selectionnes.indexOf(r),n=(equipements_techniques_selectionnes.splice(t,1),generer_url_sviewer());afficher_resultat(n,largeur_iframe,hauteur_iframe)}),$("input[name=configuration_sviewer]").change(function(){configueration_sviewer_selectionne=$("input[name=configuration_sviewer]:checked").val();var e=generer_url_sviewer();afficher_resultat(e,largeur_iframe,hauteur_iframe)}),$("#titre_sviewer").on("input",function(){titre_carte=$("#titre_sviewer").val();var e=generer_url_sviewer();afficher_resultat(e,largeur_iframe,hauteur_iframe)}),$("#largeur_iframe").on("input",function(){largeur_iframe=$("#largeur_iframe").val();var e=generer_url_sviewer();afficher_resultat(e,largeur_iframe,hauteur_iframe)}),$("#hauteur_iframe").on("input",function(){hauteur_iframe=$("#hauteur_iframe").val();var e=generer_url_sviewer();afficher_resultat(e,largeur_iframe,hauteur_iframe)}),map.on("zoomend",function(){map_centre_lat=map.getCenter().lat,map_centre_lng=map.getCenter().lng,map_zoom=map.getZoom();var e=generer_url_sviewer();afficher_resultat(e,largeur_iframe,hauteur_iframe)}),map.on("mouseup",function(){map_centre_lat=map.getCenter().lat,map_centre_lng=map.getCenter().lng,map_zoom=map.getZoom();var e=generer_url_sviewer();afficher_resultat(e,largeur_iframe,hauteur_iframe)});