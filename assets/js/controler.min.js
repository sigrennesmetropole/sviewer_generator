var geojsonLayerMap,fond_plan_defaut_selectionne,nom_commune_selectionne,theme_site_orgs_selectionnes,equipements_techniques_selectionnes,data_sites_orgs,data_donnees_metiers,nom_label_url,nom_label_code,url_api_cadastre,url_sviewer,layer_pvci=L.tileLayer("https://public.sig.rennesmetropole.fr/geowebcache/service/tms/1.0.0/ref_fonds%3Apvci@EPSG%3A3857@png/{z}/{x}/{y}.png",{attribution:"Plan de ville communal et intercommunal, Référentiel voies et adresses : Rennes Métropole",id:1,center:[48.1,-1.67],minZoom:0,maxZoom:20,tms:!0}),map=L.map("carte_emprise",{center:[48.1,-1.67],zoom:12,layers:[layer_pvci]}),configueration_sviewer_selectionne=$("input[name=configuration_sviewer]:checked").val(),titre_carte=$("#titre_sviewer").val(),largeur_iframe=$("#largeur_iframe").val(),hauteur_iframe=$("#hauteur_iframe").val(),map_centre_lat=map.getCenter().lat,map_centre_lng=map.getCenter().lng,map_zoom=map.getZoom();function generer_url_sviewer(){var e,r,t=url_sviewer+"?x="+map_centre_lng+"&y="+map_centre_lat+"&z="+map_zoom+"&lb="+fond_plan_defaut_selectionne;""!=titre_carte&&(t+="&title="+encodeURIComponent(titre_carte)),e=void 0!==theme_site_orgs_selectionnes?theme_site_orgs_selectionnes.length:-1,r=void 0!==equipements_techniques_selectionnes?equipements_techniques_selectionnes.length:-1;var a="";if(e>0){t+="&layers=",a=theme_site_orgs_selectionnes[0];for(var i=1;i<e-1;i++)a+=","+theme_site_orgs_selectionnes[i];if(r>0)for(var n=0;n<r-1;n++)a+=","+equipements_techniques_selectionnes[n];t+=encodeURIComponent(a)}else if(r>0){t+="&layers=",a=equipements_techniques_selectionnes[0];for(var _=1;_<r-1;_++)a+=","+equipements_techniques_selectionnes[_];t+=encodeURIComponent(a)}return"allegee"==configueration_sviewer_selectionne&&(t+="&c=light"),t}function afficher_coordonnees_carte(e,r){var t={color:r,weight:3,opacity:1};null!=geojsonLayerMap&&map.removeLayer(geojsonLayerMap),""!=e&&(geojsonLayerMap=L.geoJSON(e,{style:t}).addTo(map),map.fitBounds(geojsonLayerMap.getBounds()))}function afficher_select2(e,r,t,a,i){$("#"+e).select2({minimumInputLength:0,width:"100%",language:languageFr,placeholder:t,closeOnSelect:a,allowClear:i,data:r})}function a(e){var r=$("#"+e).val();console.log(r)}function afficher_url_sviewer(e){var r='<div class="affichage_horizontal"> <label class="form-check-label espace_droite" for="conf_complete"> '+nom_label_url+'</label><textarea id="url_carte" onchange="a(\'url_carte\')" class="form-control">'+e+" </textarea> </div>";$("#affichage_url_sviewer").html(r)}function afficher_code_iframe(e,r,t){var a='<div class="affichage_horizontal"> <label class="form-check-label espace_droite" for="conf_complete"> '+nom_label_code+'</label><textarea id="code_iframe" class="form-control">'+('<iframe width="'+e+'" height="'+r+'" src="'+t+'"> </iframe>')+" </textarea> </div>";$("#affichage_code").html(a)}function afficher_resultat_iframe(e,r,t){var a='<iframe id="iframe_sviewer" width="'+e+'" height="'+r+'" src="'+t+'"> </iframe>';$("#visualisation_resultat").html(a)}function afficher_resultat(e,r,t){afficher_url_sviewer(e),afficher_code_iframe(r,t,e),afficher_resultat_iframe(r,t,e)}var languageFr={inputTooShort:function(e){return"Saisissez au moins "+e.minimum+" caractères"},errorLoading:function(){return"Les résultats ne peuvent pas être chargés."},inputTooLong:function(e){return"Vous pouvez entrer seulement "+e.maximum+" caractères"},noResults:function(){return"Aucun résultat trouvé"},searching:function(){return"Recherche en cours…"},maximumSelected:function(e){return"Vous pouvez seulement sélectionner "+e.maximum+" élément"+(e.maximum>1)?"s":""}};$("#liste_communes").on("select2:select",function(e){var r=e.params.data;""!=r.id&&1!=r.id&&$.get(url_api_cadastre+"epsg:4326/commune/"+r.id,function(e){afficher_coordonnees_carte(e.coordonnees,"#6a00ff")}),nom_commune_selectionne=$("#liste_communes").val(),afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe)}),$("#liste_site_org_cb").change(function(){this.checked&&(data_sites_orgs.forEach(function(e){theme_site_orgs_selectionnes.push(e.id)}),$("#liste_site_org").val(theme_site_orgs_selectionnes).trigger("change"),afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe),console.log(document.getElementById("iframe_sviewer").src))}),$("#liste_equipements_techniques_cb").change(function(){this.checked&&data_donnees_metiers.forEach(function(e){equipements_techniques_selectionnes.push(e.id)}),$("#liste_equipements_techniques").val(equipements_techniques_selectionnes).trigger("change"),afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe)}),$("#liste_fonds_plans").on("select2:select",function(e){fond_plan_defaut_selectionne=$("#liste_fonds_plans").val(),afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe)}),$("#liste_site_org").on("select2:select",function(e){theme_site_orgs_selectionnes=$("#liste_site_org").val(),afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe)}),$("#liste_site_org").on("select2:unselecting",function(e){var r=e.params.args.data.id,t=theme_site_orgs_selectionnes.indexOf(r);theme_site_orgs_selectionnes.splice(t,1);afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe),$("#liste_site_org_cb").prop("checked",!1)}),$("#liste_equipements_techniques").on("select2:select",function(e){equipements_techniques_selectionnes=$("#liste_equipements_techniques").val(),afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe)}),$("#liste_equipements_techniques").on("select2:unselecting",function(e){var r=e.params.args.data.id,t=equipements_techniques_selectionnes.indexOf(r);equipements_techniques_selectionnes.splice(t,1);afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe),$("#liste_equipements_techniques_cb").prop("checked",!1)}),$("input[name=configuration_sviewer]").change(function(){configueration_sviewer_selectionne=$("input[name=configuration_sviewer]:checked").val(),afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe)}),$("#titre_sviewer").on("input",function(){titre_carte=$("#titre_sviewer").val(),afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe)}),$("#largeur_iframe").on("input",function(){largeur_iframe=$("#largeur_iframe").val(),afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe)}),$("#hauteur_iframe").on("input",function(){hauteur_iframe=$("#hauteur_iframe").val(),afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe)}),map.on("zoomend",function(){map_centre_lat=map.getCenter().lat,map_centre_lng=map.getCenter().lng,map_zoom=map.getZoom(),afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe)}),map.on("mouseup",function(){map_centre_lat=map.getCenter().lat,map_centre_lng=map.getCenter().lng,map_zoom=map.getZoom(),afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe)}),$("input[type=textarea]").bind("input propertychange",function(){console.log(this.value)}),$("#url_carte").change(function(){alert("change")}),$("#url_carte").on("input",function(){alert("change")}),$("#url_carte").on("change",function(){alert("change")}),$.when(get_configuration_data()).done(function(e){$("#nom_application").html(e.nom_application),$("#titre_page").html(e.titre_application),$("#detail_text").html(e.detail_text),$("#partie_configuration_carte").prepend(e.partie_configuration_carte[0].nom_partie_configuration_carte+" "),$("#titre_partie_cadrage").html(e.partie_configuration_carte[0].nom_choix_cadrage),$("#titre_choix_donnees").html(e.partie_configuration_carte[0].nom_choix_donnees),$("#label_fond_plan").html(e.partie_configuration_carte[0].nom_label_fond_plan),$("#label_sites_orgs").html(e.partie_configuration_carte[0].nom_label_sites_orgs),$("#label_donnees_metiers").html(e.partie_configuration_carte[0].nom_label_donnees_metires),$("#titre_choix_interface").html(e.partie_configuration_carte[0].nom_choix_interface),$("#label_configuration_complete").append(e.partie_configuration_carte[0].nom_interface_complete),$("#label_configuration_allegee").append(e.partie_configuration_carte[0].nom_interface_allegee),$("#titre_titre_carte").html(e.partie_configuration_carte[0].nom_choix_titre_carte),$("#titre_taille_carte").html(e.partie_configuration_carte[0].nom_choix_taille_carte),$("#titre_apercu_carte").prepend(e.partie_apercu_carte[0].nom_partie_apercu_carte+" "),$("#titre_partage").prepend(e.partie_partage[0].nom_partie_partage+" "),$("#label_largeur").html(e.partie_configuration_carte[0].nom_label_largeur),$("#label_hauteur").html(e.partie_configuration_carte[0].nom_label_hauteur),$("#largeur_iframe").val(e.partie_configuration_carte[0].largeur_carte_par_defaut),$("#hauteur_iframe").val(e.partie_configuration_carte[0].hauteur_carte_par_defaut),nom_label_url=e.partie_partage[0].nom_champ_url,nom_label_code=e.partie_partage[0].nom_champ_code_html,$("#version").append("<p> version "+e.numero_version+"</p>"),url_api_cadastre=e.url_api_cadastre_Rennes_Metropole,url_sviewer=e.localisation_sviewer,$("#largeur_iframe").attr("max",e.partie_configuration_carte[0].largeur_max_carte),$("#hauteur_iframe").attr("max",e.partie_configuration_carte[0].hauteur_max_carte),largeur_iframe=$("#largeur_iframe").val(),hauteur_iframe=$("#hauteur_iframe").val(),map.setZoom(e.partie_configuration_carte[0].zoom_carte_par_defaut),$("#titre_sviewer").val(e.partie_configuration_carte[0].titre_carte_par_defaut),titre_carte=$("#titre_sviewer").val(),$.when(get_liste_communes(url_api_cadastre)).done(function(e){afficher_select2("liste_communes",$.map(e,function(e){return{text:e.name,id:e.idComm}}),"choix de la commune",!0,!1),afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe)})}),$.when(get_donnees_sites_orgs()).done(function(e){afficher_select2("liste_site_org",data_sites_orgs=$.map(e.sites_organismes,function(e){return{text:e.text,id:e.couche}}),"themes sites & organismes",!1,!0),theme_site_orgs_selectionnes=$("#liste_site_org").val(),afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe)}),$.when(get_fonds_plan()).done(function(e){afficher_select2("liste_fonds_plans",$.map(e.fonds_plans,function(e){return{text:e.text,id:e.id}}),"choix du fond de plan par defaut",!0,!1),$("#liste_fonds_plans").val("0").trigger("change"),fond_plan_defaut_selectionne=$("#liste_fonds_plans").val(),afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe)}),$.when(get_donnees_metiers()).done(function(e){afficher_select2("liste_equipements_techniques",data_donnees_metiers=$.map(e.donnees_metiers,function(e){return{text:e.nom,id:e.couche}}),"donnees metiers",!1,!0),equipements_techniques_selectionnes=$("#liste_equipements_techniques").val(),afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe)});