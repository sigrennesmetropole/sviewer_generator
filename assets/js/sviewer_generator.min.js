function get_configuration_data(){return $.ajax({type:"GET",url:"assets/json/configuration.json",dataType:"json"})}function get_liste_communes(e){return $.ajax({type:"GET",url:e+"communes",dataType:"json"})}function get_donnees_sites_orgs(){return $.ajax({type:"GET",url:"assets/json/donnees_sites_orgs.json",dataType:"json"})}function get_fonds_plan(){return $.ajax({type:"GET",url:"assets/json/fonds_plans.json",dataType:"json"})}function get_donnees_metiers(){return $.ajax({type:"GET",url:"assets/json/donnees_metiers.json",dataType:"json"})}function requette_getcapabilities(e){return $.ajax({type:"GET",url:e,dataType:"xml"})}
var url_sviewer,geojsonLayerMap,fond_plan_defaut_selectionne,nom_commune_selectionne,theme_site_orgs_selectionnes,equipements_techniques_selectionnes,largeur_iframe,hauteur_iframe,hauteur_iframe_glimpse,largeur_iframe_glimpse,data_sites_orgs,data_donnees_metiers,url_api_cadastre,url_geoserver,layer_pvci=L.tileLayer("https://public.sig.rennesmetropole.fr/geowebcache/service/tms/1.0.0/ref_fonds%3Apvci@EPSG%3A3857@png/{z}/{x}/{y}.png",{attribution:"Plan de ville communal et intercommunal, Référentiel voies et adresses : Rennes Métropole",id:1,center:[48.1,-1.67],minZoom:0,maxZoom:20,tms:!0}),map=L.map("carte_emprise",{center:[48.1,-1.67],zoom:12,layers:[layer_pvci]}),configuration_sviewer_selectionne=$("input[name=configuration_sviewer]:checked").val(),titre_carte=$("#titre_sviewer").val(),map_centre_lat=map.getCenter().lat,map_centre_lng=map.getCenter().lng,map_zoom=map.getZoom();function check_equipements_techniques_selectionnes(){equipements_techniques_selectionnes_length=void 0!==equipements_techniques_selectionnes?equipements_techniques_selectionnes.length:-1;for(var e=0;e<equipements_techniques_selectionnes_length;e++)getcapabilities_request=url_geoserver+equipements_techniques_selectionnes[e].replace(":","/")+"/wms?service=wms&request=getcapabilities"}function check_theme_site_orgs_selectionnes(){for(theme_site_orgs_selectionnes_length=void 0!==theme_site_orgs_selectionnes?theme_site_orgs_selectionnes.length:-1,i=0;i<theme_site_orgs_selectionnes_length;i++)getcapabilities_request=url_geoserver+theme_site_orgs_selectionnes[i].replace(":","/")+"/wms?service=wms&request=getcapabilities",$.ajax(getcapabilities_request).fail(function(e,r){})}function generer_url_sviewer(){var e,r,t=url_sviewer+"?x="+map_centre_lng+"&y="+map_centre_lat+"&z="+map_zoom+"&lb="+fond_plan_defaut_selectionne;""!=titre_carte&&(t+="&title="+encodeURIComponent(titre_carte)),e=void 0!==theme_site_orgs_selectionnes?theme_site_orgs_selectionnes.length:-1,r=void 0!==equipements_techniques_selectionnes?equipements_techniques_selectionnes.length:-1;var a="";if(e>0){t+="&layers=";for(var i=0;i<e;i++)a+=","+theme_site_orgs_selectionnes[i];r>0&&(a+=","+equipements_techniques_selectionnes[j]),t+=encodeURIComponent(a)}else if(r>0){t+="&layers=",a=equipements_techniques_selectionnes[0];for(var _=1;_<r;_++)a+=","+equipements_techniques_selectionnes[_];t+=encodeURIComponent(a)}return"allegee"==configuration_sviewer_selectionne&&(t+="&c=light"),t}function afficher_coordonnees_carte(e,r){var t={color:r,weight:3,opacity:1};null!=geojsonLayerMap&&map.removeLayer(geojsonLayerMap),""!=e&&(geojsonLayerMap=L.geoJSON(e,{style:t}).addTo(map),map.fitBounds(geojsonLayerMap.getBounds()))}function afficher_select2(e,r,t,a,i){$("#"+e).select2({minimumInputLength:0,width:"100%",language:languageFr,placeholder:t,closeOnSelect:a,allowClear:i,data:r})}function decomposer_argument_layers(e){liste_layers=e.split(","),liste_layers.forEach(function(e){-1!=e.search("sv_sitorg")?theme_site_orgs_selectionnes=e:-1!=e.search("sv_metier")&&(equipements_techniques_selectionnes=e)})}function gerer_changement_url(e){var r=$("#"+e).val().split("?");r[0],r[1].split("&").forEach(function(e){var r=e.split("=");switch(r[0]){case"x":map_centre_lng=r[1];break;case"y":map_centre_lat=r[1];break;case"z":map_zoom=r[1];break;case"lb":fond_plan_defaut_selectionne=r[1];break;case"title":var t=r[1].split('"')[0];titre_carte=decodeURIComponent(t);break;case"layers":decomposer_argument_layers(decodeURIComponent(r[1]));break;case"c":configuration_sviewer_selectionne=r[1]}});var t=generer_url_sviewer();afficher_resultat(t,largeur_iframe,hauteur_iframe)}function afficher_url_sviewer(e){var r='<div class="padding_bottom"><textarea id="url_carte" onchange="gerer_changement_url(\'url_carte\')" class="form-control">'+e+" </textarea> </div>";$("#affichage_url_sviewer").html(r)}function afficher_code_iframe(e){var r='<div class="padding_bottom"><textarea id="code_iframe" onchange="gerer_changement_url(\'code_iframe\')" class="form-control">'+('<iframe frameborder="0" width="'+largeur_iframe+'" height="'+hauteur_iframe+'" src="'+e+'"> </iframe>')+" </textarea> </div>";$("#affichage_code").html(r)}function afficher_resultat_iframe(e){var r='<iframe id="iframe_sviewer" width="'+largeur_iframe_glimpse+'" height="'+hauteur_iframe_glimpse+'" src="'+e+'"> </iframe>';$("#visualisation_resultat").html(r)}function afficher_resultat(e,r,t){afficher_url_sviewer(e),afficher_code_iframe(e),afficher_resultat_iframe(e)}"pixels"==$("input[name=taille_iframe]:checked").val()?(largeur_iframe=$("#largeur_iframe_pixel").val(),hauteur_iframe=$("#hauteur_iframe_pixel").val(),$("#largeur_iframe_pixel").attr("disabled",!1),$("#hauteur_iframe_pixel").attr("disabled",!1),$("#largeur_iframe_pourcent").attr("disabled",!0),$("#hauteur_iframe_pourcent").attr("disabled",!0)):"pourcentage"==$("input[name=taille_iframe]:checked").val()&&(largeur_iframe=$("#largeur_iframe_pourcent").val()+"%",hauteur_iframe=$("#hauteur_iframe_pourcent").val()+"%",$("#largeur_iframe_pixel").attr("disabled",!0),$("#hauteur_iframe_pixel").attr("disabled",!0),$("#largeur_iframe_pourcent").attr("disabled",!1),$("#hauteur_iframe_pourcent").attr("disabled",!1));var languageFr={inputTooShort:function(e){return"Saisissez au moins "+e.minimum+" caractères"},errorLoading:function(){return"Les résultats ne peuvent pas être chargés."},inputTooLong:function(e){return"Vous pouvez entrer seulement "+e.maximum+" caractères"},noResults:function(){return"Aucun résultat trouvé"},searching:function(){return"Recherche en cours…"},maximumSelected:function(e){return"Vous pouvez seulement sélectionner "+e.maximum+" élément"+(e.maximum>1)?"s":""}};$("#liste_communes").on("select2:select",function(e){var r=e.params.data;""!=r.id&&1!=r.id&&$.get(url_api_cadastre+"epsg:4326/commune/"+r.id,function(e){afficher_coordonnees_carte(e.coordonnees,"#6a00ff")}),nom_commune_selectionne=$("#liste_communes").val(),afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe)}),$("#liste_site_org_cb").change(function(){this.checked&&(data_sites_orgs.forEach(function(e){theme_site_orgs_selectionnes.push(e.id)}),$("#liste_site_org").val(theme_site_orgs_selectionnes).trigger("change"),afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe))}),$("#liste_equipements_techniques_cb").change(function(){this.checked&&data_donnees_metiers.forEach(function(e){equipements_techniques_selectionnes.push(e.id)}),$("#liste_equipements_techniques").val(equipements_techniques_selectionnes).trigger("change"),afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe)}),$("#liste_fonds_plans").on("select2:select",function(e){fond_plan_defaut_selectionne=$("#liste_fonds_plans").val(),afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe)}),$("#liste_site_org").on("select2:select",function(e){theme_site_orgs_selectionnes=$("#liste_site_org").val(),afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe)}),$("#liste_site_org").on("select2:unselecting",function(e){var r=e.params.args.data.id,t=theme_site_orgs_selectionnes.indexOf(r);theme_site_orgs_selectionnes.splice(t,1);afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe),$("#liste_site_org_cb").prop("checked",!1)}),$("#liste_equipements_techniques").on("select2:select",function(e){equipements_techniques_selectionnes=$("#liste_equipements_techniques").val(),afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe)}),$("#liste_equipements_techniques").on("select2:unselecting",function(e){var r=e.params.args.data.id,t=equipements_techniques_selectionnes.indexOf(r);equipements_techniques_selectionnes.splice(t,1);afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe),$("#liste_equipements_techniques_cb").prop("checked",!1)}),$("input[name=configuration_sviewer]").change(function(){configuration_sviewer_selectionne=$("input[name=configuration_sviewer]:checked").val(),afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe)}),$("#titre_sviewer").on("input",function(){titre_carte=$("#titre_sviewer").val(),afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe)}),map.on("zoomend",function(){map_centre_lat=map.getCenter().lat,map_centre_lng=map.getCenter().lng,map_zoom=map.getZoom(),afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe)}),map.on("mouseup",function(){map_centre_lat=map.getCenter().lat,map_centre_lng=map.getCenter().lng,map_zoom=map.getZoom(),afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe)}),$("#largeur_iframe_pixel").on("input",function(){largeur_iframe=$("#largeur_iframe_pixel").val(),afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe)}),$("#hauteur_iframe_pixel").on("input",function(){hauteur_iframe=$("#hauteur_iframe_pixel").val(),afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe)}),$("#largeur_iframe_pourcent").on("input",function(){largeur_iframe=$("#largeur_iframe_pourcent").val()+"%",afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe)}),$("#hauteur_iframe_pourcent").on("input",function(){hauteur_iframe=$("#hauteur_iframe_pourcent").val()+"%",afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe)}),$("input[name=taille_iframe]").change(function(){var e=$("input[name=taille_iframe]:checked").val();"pixels"==e?($("#largeur_iframe_pixel").attr("disabled",!1),$("#hauteur_iframe_pixel").attr("disabled",!1),$("#largeur_iframe_pourcent").attr("disabled",!0),$("#hauteur_iframe_pourcent").attr("disabled",!0),largeur_iframe=$("#largeur_iframe_pixel").val(),hauteur_iframe=$("#hauteur_iframe_pixel").val()):"pourcentage"==e&&($("#largeur_iframe_pixel").attr("disabled",!0),$("#hauteur_iframe_pixel").attr("disabled",!0),$("#largeur_iframe_pourcent").attr("disabled",!1),$("#hauteur_iframe_pourcent").attr("disabled",!1),largeur_iframe=$("#largeur_iframe_pourcent").val()+"%",hauteur_iframe=$("#hauteur_iframe_pourcent").val()+"%"),afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe)}),$.when(get_configuration_data()).done(function(e){$(".nom_application").html(e.nom_application),$(".text_explicatif").html(e.titre_application),$("#detail_text").html(e.detail_text),$("#explication_point_interrogation").append(" "+e.explication_point_interrogation),$("#partie_configuration_carte").prepend(e.partie_configuration_carte[0].nom_partie_configuration_carte+" "),$("#titre_partie_cadrage").prepend(e.partie_configuration_carte[0].nom_choix_cadrage+" "),$("#titre_choix_donnees").prepend(e.partie_configuration_carte[0].nom_choix_donnees+" "),$("#label_fond_plan").html(e.partie_configuration_carte[0].nom_label_fond_plan),$("#label_sites_orgs").html(e.partie_configuration_carte[0].nom_label_sites_orgs),$("#label_donnees_metiers").html(e.partie_configuration_carte[0].nom_label_donnees_metires),$("#titre_choix_interface").prepend(e.partie_configuration_carte[0].nom_choix_interface+" "),$("#label_configuration_complete").append(e.partie_configuration_carte[0].nom_interface_complete),$("#label_configuration_allegee").append(e.partie_configuration_carte[0].nom_interface_allegee),$("#titre_titre_carte").prepend(e.partie_configuration_carte[0].nom_choix_titre_carte+" "),$("#titre_taille_carte").html(e.partie_configuration_carte[0].nom_choix_taille_carte),$("#titre_apercu_carte").prepend(e.partie_apercu_carte[0].nom_partie_apercu_carte+" "),$("#titre_partage").prepend(e.partie_partage[0].nom_partie_partage+" "),$("#label_largeur_pixel").html(e.partie_partage[0].nom_label_largeur),$("#label_hauteur_pixel").html(e.partie_partage[0].nom_label_hauteur),$("#label_largeur_pourcent").html(e.partie_partage[0].nom_label_largeur),$("#label_hauteur_pourcent").html(e.partie_partage[0].nom_label_hauteur),$("#largeur_iframe").val(e.partie_configuration_carte[0].largeur_carte_par_defaut),$("#hauteur_iframe").val(e.partie_configuration_carte[0].hauteur_carte_par_defaut),$("#titre_envoie_lien").prepend(e.partie_partage[0].nom_champ_url+" "),$("#lien_reducteur_url").html(e.partie_partage[0].nom_lien_reducteur_url),$("#titre_taille_iframe").html(e.partie_partage[0].nom_titre_taille_iframe),$("#label_taille_pixel").append(e.partie_partage[0].nom_label_pixel),$("#label_taille_pourcent").append(e.partie_partage[0].nom_label_pourcentage),$("#code_html_iframe").prepend(e.partie_partage[0].nom_champ_code_html+" "),$(".version").append("<p> version "+e.numero_version+"</p>"),$("#aide_configuration_carte").popover({content:e.partie_configuration_carte[0].infobulle_configuration_carte}),$("#aide_titre_carte").popover({content:e.partie_configuration_carte[0].infobulle_titre_carte}),$("#aide_cadrage").popover({content:e.partie_configuration_carte[0].infobulle_choix_cadrage}),$("#aide_choix_interface").popover({content:e.partie_configuration_carte[0].infobulle_choix_interface}),$("#aide_choix_donnees").popover({content:e.partie_configuration_carte[0].infobulle_choix_donnees}),$("#aide_apercu").popover({content:e.partie_apercu_carte[0].infobulle_apercu_carte}),$("#aide_partage").popover({content:e.partie_partage[0].infobulle_partage}),$("#aide_envoyer_lien").popover({content:e.partie_partage[0].infobulle_envoyer_lien}),$("#aide_integrer_carte").popover({content:e.partie_partage[0].infobulle_integrer_carte}),url_api_cadastre=e.url_api_cadastre_Rennes_Metropole,url_sviewer=e.localisation_sviewer,url_geoserver=e.url_geoserver,largeur_iframe=e.partie_configuration_carte[0].largeur_carte_apercu,hauteur_iframe=e.partie_configuration_carte[0].hauteur_carte_apercu,largeur_iframe_glimpse=e.partie_configuration_carte[0].largeur_carte_apercu,hauteur_iframe_glimpse=e.partie_configuration_carte[0].hauteur_carte_apercu,map.setZoom(e.partie_configuration_carte[0].zoom_carte_par_defaut),$("#titre_sviewer").val(e.partie_configuration_carte[0].titre_carte_par_defaut),titre_carte=$("#titre_sviewer").val(),$("#liste_site_org_cb").prop("checked",!1),$("#liste_equipements_techniques_cb").prop("checked",!1),$.when(get_liste_communes(url_api_cadastre)).done(function(e){afficher_select2("liste_communes",$.map(e,function(e){return{text:e.name,id:e.idComm}}),"choix de la commune",!0,!1),afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe)})}),$.when(get_donnees_sites_orgs()).done(function(e){afficher_select2("liste_site_org",data_sites_orgs=$.map(e.sites_organismes,function(e){return{text:e.text,id:e.couche}}),"themes sites & organismes",!1,!0),theme_site_orgs_selectionnes=$("#liste_site_org").val(),afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe)}),$.when(get_fonds_plan()).done(function(e){afficher_select2("liste_fonds_plans",$.map(e.fonds_plans,function(e){return{text:e.text,id:e.id}}),"choix du fond de plan par defaut",!0,!1),$("#liste_fonds_plans").val("0").trigger("change"),fond_plan_defaut_selectionne=$("#liste_fonds_plans").val(),afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe)}),$.when(get_donnees_metiers()).done(function(e){afficher_select2("liste_equipements_techniques",data_donnees_metiers=$.map(e.donnees_metiers,function(e){return{text:e.nom,id:e.couche}}),"donnees metiers",!1,!0),equipements_techniques_selectionnes=$("#liste_equipements_techniques").val(),afficher_resultat(generer_url_sviewer(),largeur_iframe,hauteur_iframe)}),$("#copy_url").on("click",function(e){$("#url_carte").select(),document.execCommand("copy")}),$("#copy_code").on("click",function(e){$("#code_iframe").select(),document.execCommand("copy")});