var num_version="1.0",base_url_sviewer="https://public.sig.rennesmetropole.fr/sviewer/",base_url_cadastre="https://api-cadastre.sig.rennesmetropole.fr/v1/";
var languageFr={inputTooShort:function(e){return"Saisissez au moins "+e.minimum+" caractères"},errorLoading:function(){return"Les résultats ne peuvent pas être chargés."},inputTooLong:function(e){return"Vous pouvez entrer seulement "+e.maximum+" caractères"},noResults:function(){return"Aucun résultat trouvé"},searching:function(){return"Recherche en cours…"},maximumSelected:function(e){return"Vous pouvez seulement sélectionner "+e.maximum+" élément"+(e.maximum>1)?"s":""}};function afficher_select2(e,r,a,t,i){$("#"+e).select2({minimumInputLength:0,width:"100%",language:languageFr,placeholder:a,closeOnSelect:t,allowClear:i,data:r})}function afficher_url_sviewer(e){var r='<div class="affichage_horizontal"> <label class="form-check-label espace_droite" for="conf_complete"> URL sviewer </label><textarea readonly class="form-control" readonly>'+e+" </textarea> </div>";$("#affichage_url_sviewer").html(r)}function afficher_code_iframe(e,r,a){var t='<div class="affichage_horizontal"> <label class="form-check-label espace_droite" for="conf_complete"> code HTML </label><textarea readonly class="form-control" readonly>'+('<iframe width="'+e+'" height="'+r+'" src="'+a+'"> </iframe>')+" </textarea> </div>";$("#affichage_code").html(t)}function afficher_resultat_iframe(e,r,a){var t='<iframe width="'+e+'" height="'+r+'" src="'+a+'"> </iframe>';$("#visualisation_resultat").html(t)}function deplacer_footer(){$("#application").css("height","800")}function afficher_resultat(e,r,a){afficher_url_sviewer(e),afficher_code_iframe(r,a,e),afficher_resultat_iframe(r,a,e),deplacer_footer()}$("#version").append("<p> version "+num_version+"</p>");
var geojsonLayerMap,fond_plan_defaut_selectionne,nom_commune_selectionne,theme_site_orgs_selectionnes,equipements_techniques_selectionnes,data_sites_orgs,data_donnees_metiers,layer_pvci=L.tileLayer("https://public.sig.rennesmetropole.fr/geowebcache/service/tms/1.0.0/ref_fonds%3Apvci@EPSG%3A3857@png/{z}/{x}/{y}.png",{attribution:"Plan de ville communal et intercommunal, Référentiel voies et adresses : Rennes Métropole",id:1,center:[48.1,-1.67],minZoom:0,maxZoom:20,tms:!0}),map=L.map("carte_emprise",{center:[48.1,-1.67],zoom:10,layers:[layer_pvci]}),configueration_sviewer_selectionne=$("input[name=configuration_sviewer]:checked").val(),titre_carte=$("#titre_sviewer").val(),largeur_iframe=$("#largeur_iframe").val(),hauteur_iframe=$("#hauteur_iframe").val(),map_centre_lat=map.getCenter().lat,map_centre_lng=map.getCenter().lng,map_zoom=map.getZoom();function generer_url_sviewer(){var e,r,t=base_url_sviewer+"?x="+map_centre_lng+"&y="+map_centre_lat+"&z="+map_zoom+"&lb="+fond_plan_defaut_selectionne;""!=titre_carte&&(t+="&title="+encodeURIComponent(titre_carte)),e=void 0!==theme_site_orgs_selectionnes?theme_site_orgs_selectionnes.length:-1,r=void 0!==equipements_techniques_selectionnes?equipements_techniques_selectionnes.length:-1;var n="";if(e>0){t+="&layers=",n=theme_site_orgs_selectionnes[0];for(var i=1;i<e-1;i++)n+=","+theme_site_orgs_selectionnes[i];if(r>0)for(var s=0;s<r-1;s++)n+=","+equipements_techniques_selectionnes[s];t+=encodeURIComponent(n)}else if(r>0){t+="&layers=",n=equipements_techniques_selectionnes[0];for(var a=1;a<r-1;a++)n+=","+equipements_techniques_selectionnes[a];t+=encodeURIComponent(n)}return"allegee"==configueration_sviewer_selectionne&&(t+="&c=light"),t}function afficher_coordonnees_carte(e,r){var t={color:r,weight:3,opacity:1};null!=geojsonLayerMap&&map.removeLayer(geojsonLayerMap),""!=e&&(geojsonLayerMap=L.geoJSON(e,{style:t}).addTo(map),map.fitBounds(geojsonLayerMap.getBounds()))}$("#liste_communes").on("select2:select",function(e){var r=e.params.data;""!=r.id&&1!=r.id&&$.get(base_url_cadastre+"epsg:4326/commune/"+r.id,function(e){afficher_coordonnees_carte(e.coordonnees,"#6a00ff")}),nom_commune_selectionne=$("#liste_communes").val();var t=generer_url_sviewer();afficher_resultat(t,largeur_iframe,hauteur_iframe)}),$.getJSON(base_url_cadastre+"communes",function(e){var r=$.map(e,function(e){return{text:e.name,id:e.idComm}});afficher_select2("liste_communes",r,"choix de la commune",!0,!1),$("#liste_communes").val("350001").trigger("change"),nom_commune_selectionne=$("#liste_communes").val();var t=generer_url_sviewer();afficher_resultat(t,largeur_iframe,hauteur_iframe)}),$.getJSON("assets/json/donnees_sites_orgs.json",function(e){data_sites_orgs=$.map(e.sites_organismes,function(e){return{text:e.text,id:e.couche}}),afficher_select2("liste_site_org",data_sites_orgs,"themes sites & organismes",!1,!0),theme_site_orgs_selectionnes=$("#liste_site_org").val();var r=generer_url_sviewer();afficher_resultat(r,largeur_iframe,hauteur_iframe)}),$.getJSON("assets/json/fonds_plans.json",function(e){var r=$.map(e.fonds_plans,function(e){return{text:e.text,id:e.id}});afficher_select2("liste_fonds_plans",r,"choix du fond de plan par defaut",!0,!1),$("#liste_fonds_plans").val("0").trigger("change"),fond_plan_defaut_selectionne=$("#liste_fonds_plans").val();var t=generer_url_sviewer();afficher_resultat(t,largeur_iframe,hauteur_iframe)}),$.getJSON("assets/json/donnees_metiers.json",function(e){data_donnees_metiers=$.map(e.donnees_metiers,function(e){return{text:e.nom,id:e.couche}}),afficher_select2("liste_equipements_techniques",data_donnees_metiers,"donnees metiers",!1,!0),equipements_techniques_selectionnes=$("#liste_equipements_techniques").val();var r=generer_url_sviewer();afficher_resultat(r,largeur_iframe,hauteur_iframe)}),$("#liste_site_org_cb").change(function(){if(this.checked){data_sites_orgs.forEach(function(e){theme_site_orgs_selectionnes.push(e.id)}),$("#liste_site_org").val(theme_site_orgs_selectionnes).trigger("change");var e=generer_url_sviewer();afficher_resultat(e,largeur_iframe,hauteur_iframe)}}),$("#liste_equipements_techniques_cb").change(function(){this.checked&&data_donnees_metiers.forEach(function(e){equipements_techniques_selectionnes.push(e.id)}),$("#liste_equipements_techniques").val(equipements_techniques_selectionnes).trigger("change");var e=generer_url_sviewer();afficher_resultat(e,largeur_iframe,hauteur_iframe)}),$("#liste_fonds_plans").on("select2:select",function(e){fond_plan_defaut_selectionne=$("#liste_fonds_plans").val();var r=generer_url_sviewer();afficher_resultat(r,largeur_iframe,hauteur_iframe)}),$("#liste_site_org").on("select2:select",function(e){theme_site_orgs_selectionnes=$("#liste_site_org").val(),console.log(theme_site_orgs_selectionnes);var r=generer_url_sviewer();afficher_resultat(r,largeur_iframe,hauteur_iframe)}),$("#liste_site_org").on("select2:unselecting",function(e){var r=e.params.args.data.id,t=theme_site_orgs_selectionnes.indexOf(r),n=(theme_site_orgs_selectionnes.splice(t,1),generer_url_sviewer());afficher_resultat(n,largeur_iframe,hauteur_iframe),$("#liste_site_org_cb").prop("checked",!1)}),$("#liste_equipements_techniques").on("select2:select",function(e){equipements_techniques_selectionnes=$("#liste_equipements_techniques").val();var r=generer_url_sviewer();afficher_resultat(r,largeur_iframe,hauteur_iframe)}),$("#liste_equipements_techniques").on("select2:unselecting",function(e){var r=e.params.args.data.id,t=equipements_techniques_selectionnes.indexOf(r),n=(equipements_techniques_selectionnes.splice(t,1),generer_url_sviewer());afficher_resultat(n,largeur_iframe,hauteur_iframe),$("#liste_equipements_techniques_cb").prop("checked",!1)}),$("input[name=configuration_sviewer]").change(function(){configueration_sviewer_selectionne=$("input[name=configuration_sviewer]:checked").val();var e=generer_url_sviewer();afficher_resultat(e,largeur_iframe,hauteur_iframe)}),$("#titre_sviewer").on("input",function(){titre_carte=$("#titre_sviewer").val();var e=generer_url_sviewer();afficher_resultat(e,largeur_iframe,hauteur_iframe)}),$("#largeur_iframe").on("input",function(){largeur_iframe=$("#largeur_iframe").val();var e=generer_url_sviewer();afficher_resultat(e,largeur_iframe,hauteur_iframe)}),$("#hauteur_iframe").on("input",function(){hauteur_iframe=$("#hauteur_iframe").val();var e=generer_url_sviewer();afficher_resultat(e,largeur_iframe,hauteur_iframe)}),map.on("zoomend",function(){map_centre_lat=map.getCenter().lat,map_centre_lng=map.getCenter().lng,map_zoom=map.getZoom();var e=generer_url_sviewer();afficher_resultat(e,largeur_iframe,hauteur_iframe)}),map.on("mouseup",function(){map_centre_lat=map.getCenter().lat,map_centre_lng=map.getCenter().lng,map_zoom=map.getZoom();var e=generer_url_sviewer();afficher_resultat(e,largeur_iframe,hauteur_iframe)});